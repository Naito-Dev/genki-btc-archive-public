<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Genki BTC Archive — Live Verification</title>
  <style>
    :root {
      --bg: #071018;
      --panel: #0f1f2d;
      --ink: #e9f2f8;
      --muted: #9cb4c7;
      --line: #274158;
      --ok: #3ddc97;
      --warn: #f7c948;
      --accent: #4db8ff;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Avenir Next", "Segoe UI", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(1200px 600px at 20% -10%, #12314a 0%, transparent 60%),
        radial-gradient(900px 500px at 100% 0%, #1f3f30 0%, transparent 55%),
        var(--bg);
    }
    .wrap { width: min(1100px, 92vw); margin: 40px auto 72px; }
    .hero h1 { margin: 0 0 8px; font-size: clamp(28px, 4vw, 44px); line-height: 1.1; }
    .hero p { margin: 0; color: var(--muted); }
    .grid {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 14px;
      margin-top: 20px;
    }
    .card {
      background: color-mix(in srgb, var(--panel) 92%, #ffffff 8%);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 16px;
    }
    .label { color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: .06em; }
    .value { margin-top: 6px; font-size: 26px; font-weight: 700; line-height: 1.1; }
    .tiny { color: var(--muted); font-size: 12px; margin-top: 8px; }
    .panel { margin-top: 16px; }
    .banner {
      margin-top: 14px;
      border-radius: 10px;
      padding: 10px 12px;
      border: 1px solid #6a4f00;
      background: #3a2d00;
      color: #ffe08a;
      font-size: 13px;
      font-weight: 600;
      display: none;
    }
    .panel h2 { margin: 0 0 10px; font-size: 20px; }
    .chart {
      margin-top: 8px;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      background: #0a1825;
    }
    svg { width: 100%; height: 210px; display: block; }
    .axis { stroke: #39556d; stroke-width: 1; }
    .line { fill: none; stroke: var(--accent); stroke-width: 2.5; }
    .dot { fill: #bfe4ff; }
    .rows { margin-top: 12px; display: grid; gap: 8px; }
    .row {
      display: grid;
      grid-template-columns: 140px 140px 160px 1fr;
      gap: 10px;
      align-items: center;
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 10px;
      font-size: 13px;
      background: #0a1825;
    }
    .row.head {
      background: transparent;
      border-style: dashed;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .04em;
      font-size: 11px;
      font-weight: 700;
    }
    .badge {
      display: inline-block;
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 2px 10px;
      font-size: 12px;
      color: var(--ink);
    }
    .ok { color: var(--ok); }
    .warn { color: var(--warn); }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
    .btn {
      border: 1px solid var(--line);
      background: #143149;
      color: var(--ink);
      border-radius: 10px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 13px;
    }
    pre {
      margin: 12px 0 0;
      white-space: pre-wrap;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 12px;
      min-height: 44px;
      background: #0a1825;
      color: #d9e8f5;
      font-size: 12px;
    }
    .foot { margin-top: 16px; color: var(--muted); font-size: 12px; }
    .pro-card {
      margin-top: 10px;
      border: 1px dashed var(--line);
      border-radius: 12px;
      padding: 12px;
      background: #0a1825;
    }
    .pro-title { font-size: 16px; font-weight: 700; margin: 0 0 8px; }
    .pro-list { margin: 0; padding-left: 18px; color: var(--muted); font-size: 13px; }
    .pro-list li { margin: 6px 0; }
    .btn-lock {
      margin-top: 10px;
      display: inline-block;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 7px 12px;
      background: #143149;
      color: var(--ink);
      font-size: 13px;
      font-weight: 600;
      text-decoration: none;
    }
    @media (max-width: 960px) {
      .grid { grid-template-columns: 1fr 1fr; }
      .row { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 640px) {
      .grid { grid-template-columns: 1fr; }
      .row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="hero">
      <h1>Genki BTC Archive</h1>
      <p>Live verification dashboard. Hash-chained daily records. Not investment advice.</p>
      <div class="banner" data-trust-banner>NOT PUBLISHED TODAY — data not trusted.</div>
    </section>

    <section class="grid" aria-label="key metrics">
      <article class="card">
        <div class="label">Latest Date (UTC)</div>
        <div class="value" data-kpi-date>—</div>
        <div class="tiny" data-kpi-updated></div>
      </article>
      <article class="card">
        <div class="label">BTC Price</div>
        <div class="value" data-kpi-price>—</div>
        <div class="tiny" data-kpi-price-source></div>
      </article>
      <article class="card">
        <div class="label">Allocation</div>
        <div class="value" data-kpi-allocation>—</div>
        <div class="tiny" data-kpi-status></div>
      </article>
      <article class="card">
        <div class="label">Chain Integrity</div>
        <div class="value" data-kpi-chain>—</div>
        <div class="tiny" data-kpi-chain-note></div>
      </article>
      <article class="card">
        <div class="label">Portfolio Snapshot</div>
        <div class="value" data-kpi-equity>—</div>
        <div class="tiny" data-kpi-pnl></div>
      </article>
    </section>

    <section class="panel card">
      <h2>Price Trend (Latest 30 entries)</h2>
      <div class="chart">
        <svg viewBox="0 0 1000 210" preserveAspectRatio="none" data-chart-svg>
          <line class="axis" x1="0" y1="200" x2="1000" y2="200"></line>
          <polyline class="line" data-chart-line points=""></polyline>
          <g data-chart-dots></g>
        </svg>
      </div>
      <div class="tiny" data-chart-note>Loading...</div>
    </section>

    <section class="panel card">
      <h2>Recent Verified Decisions</h2>
      <div class="rows" data-rows></div>
      <div class="pro-card" data-pro-card>
        <p class="pro-title">Pro Details (Locked)</p>
        <ul class="pro-list" data-pro-list>
          <li>Target BTC%: Locked</li>
          <li>Regime rationale: Locked</li>
          <li>Next trigger: Locked</li>
        </ul>
        <span class="btn-lock">Unlock Pro</span>
      </div>
    </section>

    <section class="panel card">
      <h2>Proof Block</h2>
      <div class="actions">
        <button type="button" class="btn" data-copy-proof>Copy Latest Proof</button>
      </div>
      <pre data-proof>Loading...</pre>
    </section>

    <p class="foot">Validation model: each entry hash is computed from canonical entry JSON + <code>|prev_hash</code> using SHA-256.</p>
  </main>

  <script>
    (function () {
      var els = {
        date: document.querySelector('[data-kpi-date]'),
        updated: document.querySelector('[data-kpi-updated]'),
        price: document.querySelector('[data-kpi-price]'),
        priceSource: document.querySelector('[data-kpi-price-source]'),
        allocation: document.querySelector('[data-kpi-allocation]'),
        status: document.querySelector('[data-kpi-status]'),
        chain: document.querySelector('[data-kpi-chain]'),
        chainNote: document.querySelector('[data-kpi-chain-note]'),
        equity: document.querySelector('[data-kpi-equity]'),
        pnl: document.querySelector('[data-kpi-pnl]'),
        rows: document.querySelector('[data-rows]'),
        proof: document.querySelector('[data-proof]'),
        copyProof: document.querySelector('[data-copy-proof]'),
        chartLine: document.querySelector('[data-chart-line]'),
        chartDots: document.querySelector('[data-chart-dots]'),
        chartNote: document.querySelector('[data-chart-note]'),
        trustBanner: document.querySelector('[data-trust-banner]'),
        proList: document.querySelector('[data-pro-list]')
      };
      var PRO_UNLOCKED = false;

      function fmtPrice(v) {
        return (typeof v === 'number') ? ('$' + v.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })) : 'N/A';
      }

      function fmtDecisionPrice(v) {
        return (typeof v === 'number') ? ('$' + Math.floor(v).toLocaleString()) : '—';
      }

      function normalizePosition(e) {
        var rawStatus = String(e.status || '').toUpperCase();
        var percent = null;
        if (typeof e.target_btc_ratio === 'number' && isFinite(e.target_btc_ratio)) {
          percent = Math.round(e.target_btc_ratio * 100);
        } else if (typeof e.allocation === 'number' && isFinite(e.allocation)) {
          percent = Math.round(e.allocation);
        }
        if (rawStatus === 'NO_TRADE') {
          return 'NO_TRADE';
        }
        if (typeof percent === 'number') {
          if (percent <= 0) return 'CASH';
          return 'LONG (BTC ' + percent + '%)';
        }
        return 'UNKNOWN';
      }

      function trustText(e) {
        var snap = String(e.snapshot_status || '').toUpperCase();
        var src = String(e.balance_source || '');
        var ps = String(e.price_source || '');
        var st = String(e.status || '');
        if (snap === 'SYNCED' && src === 'BITGET_READONLY' && ps !== 'cache_stale' && st !== 'DATA_STALE') {
          return '✓ Verified';
        }
        if (ps === 'cache_stale' || st === 'DATA_STALE') {
          return '⚠ Price stale';
        }
        return '✗ Data issue';
      }

      function renderRows(entries) {
        els.rows.innerHTML = '';
        var header = document.createElement('div');
        header.className = 'row head';
        header.innerHTML =
          '<div>DATE</div>' +
          '<div>SIGNAL</div>' +
          '<div>BTC PRICE</div>' +
          '<div>TRUST</div>';
        els.rows.appendChild(header);
        entries.slice(-12).reverse().forEach(function (e) {
          var row = document.createElement('div');
          row.className = 'row';
          var trust = trustText(e);
          row.innerHTML =
            '<div><strong>' + (e.date || 'N/A') + '</strong></div>' +
            '<div>' + normalizePosition(e) + '</div>' +
            '<div>' + fmtDecisionPrice(e.btc_price) + '</div>' +
            '<div>' + trust + '</div>';
          els.rows.appendChild(row);
        });
      }

      function renderPro(latest) {
        if (!els.proList) return;
        if (!PRO_UNLOCKED) {
          els.proList.innerHTML =
            '<li>Target BTC%: Locked</li>' +
            '<li>Regime rationale: Locked</li>' +
            '<li>Next trigger: Locked</li>';
          return;
        }
        var target = 'N/A';
        if (typeof latest.target_btc_ratio === 'number') {
          target = Math.round(latest.target_btc_ratio * 100) + '%';
        } else if (typeof latest.allocation === 'number') {
          target = Math.round(latest.allocation) + '%';
        }
        var regime = String(latest.regime || latest.reason_summary || 'No rationale available');
        var trigger = String(latest.trigger || 'Waiting for confirmation');
        els.proList.innerHTML =
          '<li>Target BTC%: ' + target + '</li>' +
          '<li>Regime rationale: ' + regime + '</li>' +
          '<li>Next trigger: ' + trigger + '</li>';
      }

      function renderChart(entries) {
        var points = entries
          .filter(function (e) { return typeof e.btc_price === 'number'; })
          .slice(-30)
          .map(function (e) { return ({ date: e.date, price: e.btc_price }); });

        if (!points.length) {
          els.chartLine.setAttribute('points', '');
          els.chartDots.innerHTML = '';
          els.chartNote.textContent = 'No numeric price points yet.';
          return;
        }

        var min = Math.min.apply(null, points.map(function (p) { return p.price; }));
        var max = Math.max.apply(null, points.map(function (p) { return p.price; }));
        var span = Math.max(1, max - min);
        var stepX = points.length > 1 ? (1000 / (points.length - 1)) : 0;

        var poly = points.map(function (p, i) {
          var x = i * stepX;
          var y = 200 - ((p.price - min) / span) * 180;
          return x.toFixed(1) + ',' + y.toFixed(1);
        }).join(' ');

        els.chartLine.setAttribute('points', poly);

        els.chartDots.innerHTML = points.map(function (p, i) {
          var x = i * stepX;
          var y = 200 - ((p.price - min) / span) * 180;
          return '<circle class="dot" cx="' + x.toFixed(1) + '" cy="' + y.toFixed(1) + '" r="2"></circle>';
        }).join('');

        els.chartNote.textContent =
          'Range: ' + fmtPrice(min) + ' to ' + fmtPrice(max) + ' across ' + points.length + ' points.';
      }

      function setProof(latest) {
        var text = [
          'date: ' + (latest.date || 'N/A'),
          'allocation: ' + (latest.allocation != null ? latest.allocation + '%' : 'N/A'),
          'btc_price: ' + (latest.btc_price != null ? latest.btc_price : 'null'),
          'price_source: ' + (latest.price_source || 'N/A'),
          'prev_hash: ' + (latest.prev_hash || 'null'),
          'hash: ' + (latest.hash || 'null')
        ].join('\n');
        els.proof.textContent = text;
      }

      if (els.copyProof) {
        els.copyProof.addEventListener('click', function () {
          var text = els.proof.textContent || '';
          navigator.clipboard.writeText(text).then(function () {
            els.copyProof.textContent = 'Copied';
            setTimeout(function () { els.copyProof.textContent = 'Copy Latest Proof'; }, 1200);
          });
        });
      }

      var logUrl = new URL('log.json', window.location.href);
      logUrl.searchParams.set('ts', String(Date.now()));
      fetch(logUrl.toString(), { cache: "no-store" })
        .then(function (r) { return r.json(); })
        .then(function (log) {
          var entries = Array.isArray(log.entries) ? log.entries.slice() : [];
          entries.sort(function (a, b) { return String(a.date || '').localeCompare(String(b.date || '')); });
          var latest = log.latest || entries[entries.length - 1] || {};

          els.date.textContent = latest.date || 'N/A';
          els.updated.textContent = latest.updated_at_utc ? ('Updated: ' + latest.updated_at_utc) : 'Updated: N/A';
          els.price.textContent = fmtPrice(latest.btc_price);
          els.priceSource.textContent = 'Source: ' + (latest.price_source || 'unavailable');
          els.allocation.textContent = (latest.allocation != null ? latest.allocation + '%' : 'N/A');
          els.status.textContent = 'Status: ' + (latest.status || 'N/A');
          var snapStatus = String(latest.snapshot_status || '').toUpperCase();
          var snapSource = String(latest.balance_source || '');
          var stalePrice = (latest.price_source === 'cache_stale' || latest.status === 'DATA_STALE');
          var snapEq = (latest.portfolio_snapshot && typeof latest.portfolio_snapshot.equity_usd === 'number')
            ? latest.portfolio_snapshot.equity_usd
            : latest.equity_usd;
          var eqTrusted = (snapStatus === 'SYNCED' && snapSource === 'BITGET_READONLY' && !stalePrice && typeof snapEq === 'number');
          var trusted = (snapStatus === 'SYNCED' && snapSource === 'BITGET_READONLY' && !stalePrice);
          var trustReason = 'OK';
          if (snapStatus !== 'SYNCED') trustReason = 'BALANCE_PENDING';
          else if (snapSource !== 'BITGET_READONLY') trustReason = 'SOURCE_MISMATCH';
          else if (stalePrice) trustReason = 'PRICE_STALE';
          if (trusted) {
            els.trustBanner.style.display = 'none';
            els.trustBanner.textContent = '';
          } else {
            els.trustBanner.style.display = 'block';
            els.trustBanner.textContent = 'NOT PUBLISHED TODAY — data not trusted (' +
              [snapStatus || 'UNKNOWN', (latest.price_source || 'unknown')].join(' / ') + ').';
          }
          els.equity.textContent = eqTrusted
            ? ('$' + snapEq.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }))
            : 'NOT TRUSTED';
          var targetRatio = (typeof latest.target_btc_ratio === 'number') ? latest.target_btc_ratio : null;
          var targetPct = (targetRatio != null) ? Math.round(targetRatio * 100) : null;
          var targetPos = (targetPct === 0) ? 'CASH' : 'LONG';
          var actualRatio = (typeof latest.actual_btc_ratio === 'number') ? latest.actual_btc_ratio : null;
          var actualPct = (actualRatio != null) ? (actualRatio * 100).toFixed(1) : 'UNKNOWN';
          var actualPos = latest.actual_position || latest.position || 'UNKNOWN';
          var mismatch = (targetRatio != null && actualRatio != null && Math.abs(targetRatio - actualRatio) >= 0.01);
          els.pnl.textContent = 'PnL: ' + ((typeof latest.pnl_usd === 'number')
            ? ('$' + latest.pnl_usd.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }))
            : 'N/A') +
            ' | Target: ' + (targetPct != null ? (targetPct + '% (' + targetPos + ')') : 'UNKNOWN') +
            ' | Actual: ' + actualPct + '% (' + actualPos + ')' +
            (mismatch ? ' | MISMATCH' : '') +
            ' | Snapshot: ' + (snapStatus || 'UNKNOWN') +
            ' | Reason: ' + trustReason;

          renderRows(entries);
          renderChart(entries);
          renderPro(latest);
          setProof(latest);
          var ci = String(latest.chain_integrity || 'UNKNOWN').toUpperCase();
          var cr = String(latest.chain_reason || '').trim();
          if (ci === 'VALID') {
            els.chain.textContent = 'VALID';
            els.chain.classList.add('ok');
            els.chain.classList.remove('warn');
            els.chainNote.textContent = 'Hash chain verified by run_daily.py.';
          } else if (ci === 'BROKEN') {
            els.chain.textContent = 'BROKEN';
            els.chain.classList.add('warn');
            els.chain.classList.remove('ok');
            els.chainNote.textContent = cr || 'Chain validation failed (publisher side).';
          } else {
            els.chain.textContent = 'UNKNOWN';
            els.chain.classList.add('warn');
            els.chain.classList.remove('ok');
            els.chainNote.textContent = 'Chain status not provided in this log format.';
          }
        })
        .catch(function () {
          els.trustBanner.style.display = 'block';
          els.trustBanner.textContent = 'NOT PUBLISHED TODAY — data not trusted (load error).';
          els.price.textContent = 'N/A';
          els.chain.textContent = 'ERROR';
          els.chain.classList.add('warn');
          els.chainNote.textContent = 'Unable to load log.json';
          els.proof.textContent = 'Unable to load proof block.';
        });
    })();
  </script>
</body>
</html>
