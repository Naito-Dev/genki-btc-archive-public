<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Genki BTC Archive — Portfolio Control</title>
  <style>
    :root {
      --bg: #071325;
      --bg-soft: #0e2038;
      --panel: #0f1f33;
      --panel-2: #112742;
      --line: #243d5f;
      --ink: #f4f7fb;
      --muted: #9cb0c9;
      --gold: #d7b56d;
      --gold-2: #f0cd7f;
      --ok: #2dd881;
      --bad: #ef5b5b;
      --warn: #f5bf59;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      color: var(--ink);
      font-family: "Avenir Next", "Segoe UI", "Helvetica Neue", sans-serif;
      background:
        radial-gradient(900px 520px at -10% -10%, #1f3558 0%, transparent 60%),
        radial-gradient(1000px 600px at 110% 0%, #1c2f4f 0%, transparent 62%),
        var(--bg);
      letter-spacing: 0.01em;
    }
    .wrap {
      width: min(980px, 92vw);
      margin: 0 auto;
      padding: 24px 0 60px;
    }
    .hero {
      text-align: center;
      padding: 26px 18px;
      border: 1px solid color-mix(in srgb, var(--gold) 24%, var(--line) 76%);
      border-radius: 18px;
      background: linear-gradient(145deg, rgba(17,39,66,0.95), rgba(10,24,43,0.95));
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.32);
    }
    .hero h1 {
      margin: 0 0 8px;
      color: var(--gold-2);
      font-size: clamp(20px, 4.6vw, 30px);
      font-weight: 700;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }
    .hero .subtitle {
      margin: 0 0 20px;
      color: var(--muted);
      font-size: 13px;
    }
    .equity-label {
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 12px;
      margin-bottom: 8px;
    }
    .equity-value {
      font-size: clamp(42px, 12vw, 84px);
      line-height: 1;
      font-weight: 800;
      margin: 0 0 12px;
      color: var(--ink);
    }
    .pnl-value {
      font-size: clamp(16px, 3.8vw, 24px);
      color: var(--gold-2);
      font-weight: 600;
      margin: 0;
    }
    .status-wrap {
      margin-top: 16px;
      display: grid;
      gap: 14px;
    }
    .status-card {
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 18px;
      background: linear-gradient(160deg, rgba(17,39,66,0.92), rgba(10,24,43,0.96));
    }
    .status-kicker {
      font-size: 12px;
      text-transform: uppercase;
      color: var(--muted);
      letter-spacing: 0.08em;
      margin: 0 0 6px;
    }
    .status-main {
      margin: 0;
      font-size: clamp(34px, 10vw, 56px);
      font-weight: 800;
      line-height: 1;
    }
    .status-main.long { color: var(--ok); }
    .status-main.cash, .status-main.no-trade { color: var(--bad); }
    .status-detail {
      margin-top: 10px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }
    .status-detail.compact {
      margin-top: 6px;
      font-size: 12px;
      opacity: 0.85;
    }
    .cta {
      display: inline-block;
      width: 100%;
      text-align: center;
      text-decoration: none;
      margin-top: 4px;
      border-radius: 14px;
      padding: 16px 18px;
      background: linear-gradient(100deg, #b4883c, #e0be76);
      color: #162033;
      font-weight: 800;
      font-size: clamp(16px, 4.2vw, 20px);
      border: 1px solid #f0d38d;
      box-shadow: 0 10px 22px rgba(209, 164, 78, 0.28);
    }
    .truth-banner {
      margin-top: 12px;
      border-radius: 12px;
      border: 1px solid #684f20;
      background: #2e2412;
      color: #ffe19d;
      padding: 10px 12px;
      font-size: 13px;
      font-weight: 700;
      display: none;
    }
    .meta-strip {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      color: var(--muted);
      font-size: 12px;
    }
    .meta-pill {
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 5px 10px;
      background: rgba(15,31,51,0.72);
    }
    .tech {
      margin-top: 24px;
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 14px;
      background: rgba(10,24,43,0.8);
      font-size: 12px;
    }
    .tech h2 {
      margin: 0 0 10px;
      font-size: 12px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }
    .tech-grid {
      display: grid;
      gap: 10px;
      grid-template-columns: 1fr;
      min-width: 0;
    }
    .tech-card {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px;
      background: rgba(15,31,51,0.75);
      min-width: 0;
      overflow: hidden;
    }
    .tiny-label {
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-size: 11px;
    }
    .tiny-value {
      margin-top: 4px;
      font-size: 13px;
      font-weight: 700;
    }
    .rows { margin-top: 10px; display: grid; gap: 6px; }
    .row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 3px;
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 7px 9px;
      background: rgba(11,24,43,0.75);
    }
    .row.head {
      background: transparent;
      border-style: dashed;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 10px;
      font-weight: 700;
    }
    .chart {
      margin-top: 8px;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 8px;
      background: rgba(11,24,43,0.75);
    }
    svg { width: 100%; height: 160px; display: block; }
    .axis { stroke: #2f4a69; stroke-width: 1; }
    .line { fill: none; stroke: var(--gold-2); stroke-width: 2; }
    .dot { fill: #efe0b8; }
    pre {
      margin: 8px 0 0;
      white-space: pre-wrap;
      overflow-x: auto;
      overflow-wrap: anywhere;
      word-break: break-word;
      font-size: 11px;
      line-height: 1.35;
      color: #d9e6f4;
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 8px;
      background: rgba(11,24,43,0.75);
      max-width: 100%;
    }
    .btn {
      margin-top: 8px;
      border: 1px solid var(--line);
      border-radius: 8px;
      background: rgba(16,36,61,0.92);
      color: var(--ink);
      padding: 7px 10px;
      font-size: 11px;
      cursor: pointer;
    }
    .ok { color: var(--ok); }
    .warn { color: var(--warn); }
    .err { color: var(--bad); }
    @media (min-width: 760px) {
      .status-wrap { grid-template-columns: 2fr 1fr; }
      .cta { margin-top: 0; display: flex; align-items: center; justify-content: center; }
      .tech-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .row { grid-template-columns: 120px 140px 120px 1fr; align-items: center; }
      .row.head { grid-template-columns: 120px 140px 120px 1fr; }
    }
    @media (max-width: 480px) {
      .tech-card { padding: 9px; }
      .tiny-label { font-size: 10px; }
      pre {
        font-size: 10px;
        line-height: 1.45;
      }
    }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="hero">
      <h1>Genki BTC Archive</h1>
      <p class="subtitle">Premium BTC risk-control dashboard with full audit transparency.</p>

      <div class="equity-label">Current Portfolio Equity (USD)</div>
      <p class="equity-value" data-kpi-equity>UNVERIFIED</p>
      <p class="pnl-value" data-kpi-pnl>Start baseline pending</p>
      <p class="subtitle" data-phase-note>Live tracking active</p>

      <div class="status-wrap">
        <article class="status-card">
          <p class="status-kicker">Today's Action Status</p>
          <p class="status-main" data-kpi-action>Hold Cash</p>
          <div class="status-detail compact" data-kpi-portfolio>Current allocation: BTC --% / Cash --%</div>
          <div class="status-detail compact" data-kpi-guidance>Guidance: Checking latest data.</div>
          <div class="meta-strip">
            <span class="meta-pill" data-kpi-date>DATE: --</span>
            <span class="meta-pill" data-kpi-price>PRICE: --</span>
            <span class="meta-pill" data-kpi-updated>UPDATED: --</span>
          </div>
        </article>
        <a class="cta" href="sales-page-en.html">Get daily BTC risk signal</a>
      </div>
    </section>

    <section class="tech">
      <h2>Technical & Audit Data</h2>
      <div class="tech-grid">
        <article class="tech-card">
          <div class="tiny-label">Chain Integrity</div>
          <div class="tiny-value" data-kpi-chain>UNKNOWN</div>
          <div class="tiny-label" data-kpi-chain-note>Waiting for chain verification.</div>
        </article>
        <article class="tech-card">
          <div class="tiny-label">Allocation / Status</div>
          <div class="tiny-value" data-kpi-allocation>--</div>
          <div class="tiny-label" data-kpi-status>--</div>
          <div class="tiny-label" data-kpi-trust>Status detail loading</div>
        </article>
      </div>

      <article class="tech-card" style="margin-top:10px;display:none;" aria-hidden="true">
        <div class="tiny-label">Price Trend (Latest 30 entries)</div>
        <div class="chart">
          <svg viewBox="0 0 1000 160" preserveAspectRatio="none">
            <line class="axis" x1="0" y1="150" x2="1000" y2="150"></line>
            <polyline class="line" data-chart-line points=""></polyline>
            <g data-chart-dots></g>
          </svg>
        </div>
        <div class="tiny-label" data-chart-note>Loading chart...</div>
      </article>

      <article class="tech-card" style="margin-top:10px;">
        <div class="tiny-label">Recent Verified Decisions</div>
        <div class="rows" data-rows></div>
      </article>

      <article class="tech-card" style="margin-top:10px;">
        <div class="tiny-label">Proof Block</div>
        <button type="button" class="btn" data-copy-proof>Copy Latest Proof</button>
        <pre data-proof>Loading...</pre>
      </article>
    </section>
  </main>

  <script>
    (function () {
      var els = {
        equity: document.querySelector('[data-kpi-equity]'),
        pnl: document.querySelector('[data-kpi-pnl]'),
        phaseNote: document.querySelector('[data-phase-note]'),
        action: document.querySelector('[data-kpi-action]'),
        portfolio: document.querySelector('[data-kpi-portfolio]'),
        guidance: document.querySelector('[data-kpi-guidance]'),
        trustText: document.querySelector('[data-kpi-trust]'),
        date: document.querySelector('[data-kpi-date]'),
        price: document.querySelector('[data-kpi-price]'),
        updated: document.querySelector('[data-kpi-updated]'),
        allocation: document.querySelector('[data-kpi-allocation]'),
        status: document.querySelector('[data-kpi-status]'),
        chain: document.querySelector('[data-kpi-chain]'),
        chainNote: document.querySelector('[data-kpi-chain-note]'),
        rows: document.querySelector('[data-rows]'),
        proof: document.querySelector('[data-proof]'),
        copyProof: document.querySelector('[data-copy-proof]'),
        chartLine: document.querySelector('[data-chart-line]'),
        chartDots: document.querySelector('[data-chart-dots]'),
        chartNote: document.querySelector('[data-chart-note]')
      };

      function fmtUsd(v) {
        return (typeof v === 'number')
          ? ('$' + v.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }))
          : 'N/A';
      }

      function fmtPrice(v) {
        return (typeof v === 'number')
          ? ('$' + Math.floor(v).toLocaleString())
          : '—';
      }

      function normalizePosition(e) {
        var targetRatio = (typeof e.target_btc_ratio === 'number') ? e.target_btc_ratio : null;
        if (targetRatio != null) {
          return targetRatio > 0 ? 'LONG' : 'CASH';
        }
        var p = String(e.position || '').toUpperCase();
        if (p === 'LONG' || p === 'CASH') return p;
        return (String(e.status || '').toUpperCase() === 'NO_TRADE') ? 'NO_TRADE' : 'NO_TRADE';
      }

      function actionLabel(pos) {
        var p = String(pos || 'NO_TRADE').toUpperCase();
        if (p === 'CASH') return 'Hold Cash';
        if (p === 'LONG') return 'Hold BTC';
        return 'Stand By';
      }

      function guidanceLabel(pos) {
        var p = String(pos || 'NO_TRADE').toUpperCase();
        if (p === 'CASH') return 'Defensive stance: preserve cash.';
        if (p === 'LONG') return 'Trend remains intact: continue holding BTC.';
        return 'No major action today.';
      }

      function trustState(e) {
        var snap = String(e.snapshot_status || '').toUpperCase();
        var src = String(e.balance_source || '');
        var ps = String(e.price_source || '');
        var st = String(e.status || '').toUpperCase();
        if (st === 'API_ERROR') return { trusted: false, label: 'SYSTEM HALTED (API Error)', reason: 'API_ERROR' };
        if (snap === 'SYNCED' && src === 'BITGET_READONLY' && ps !== 'cache_stale' && st !== 'DATA_STALE') {
          return { trusted: true, label: 'VERIFIED', reason: 'OK' };
        }
        if (ps === 'cache_stale' || st === 'DATA_STALE') {
          return { trusted: false, label: 'UNVERIFIED (price stale)', reason: 'PRICE_STALE' };
        }
        if (snap !== 'SYNCED') {
          return { trusted: false, label: 'Verification status: pending snapshot sync', reason: 'BALANCE_PENDING' };
        }
        if (src !== 'BITGET_READONLY') {
          return { trusted: false, label: 'UNVERIFIED (source mismatch)', reason: 'SOURCE_MISMATCH' };
        }
        return { trusted: false, label: 'UNVERIFIED (data issue)', reason: 'DATA_ISSUE' };
      }

      function renderRows(entries) {
        els.rows.innerHTML = '';
        var header = document.createElement('div');
        header.className = 'row head';
        header.innerHTML = '<div>DATE</div><div>SIGNAL</div><div>PRICE</div><div>TRUST</div>';
        els.rows.appendChild(header);

        entries.slice(-10).reverse().forEach(function (e) {
          var trust = trustState(e);
          var pos = normalizePosition(e);
          var row = document.createElement('div');
          row.className = 'row';
          row.innerHTML =
            '<div>' + (e.date || 'N/A') + '</div>' +
            '<div>' + pos + '</div>' +
            '<div>' + fmtPrice(e.btc_price) + '</div>' +
            '<div>' + trust.label + '</div>';
          els.rows.appendChild(row);
        });
      }

      function renderChart(entries) {
        var points = entries
          .filter(function (e) { return typeof e.btc_price === 'number'; })
          .slice(-30)
          .map(function (e) { return e.btc_price; });

        if (!points.length) {
          els.chartLine.setAttribute('points', '');
          els.chartDots.innerHTML = '';
          els.chartNote.textContent = 'No numeric price points yet.';
          return;
        }

        var min = Math.min.apply(null, points);
        var max = Math.max.apply(null, points);
        var span = Math.max(1, max - min);
        var stepX = points.length > 1 ? (1000 / (points.length - 1)) : 0;
        var poly = points.map(function (p, i) {
          var x = i * stepX;
          var y = 150 - ((p - min) / span) * 130;
          return x.toFixed(1) + ',' + y.toFixed(1);
        }).join(' ');
        els.chartLine.setAttribute('points', poly);
        els.chartDots.innerHTML = points.map(function (p, i) {
          var x = i * stepX;
          var y = 150 - ((p - min) / span) * 130;
          return '<circle class="dot" cx="' + x.toFixed(1) + '" cy="' + y.toFixed(1) + '" r="1.8"></circle>';
        }).join('');
        els.chartNote.textContent = 'Range: ' + fmtUsd(min) + ' to ' + fmtUsd(max) + ' (' + points.length + ' points)';
      }

      function pickNumericEquity(e) {
        if (e && e.portfolio_snapshot && typeof e.portfolio_snapshot.equity_usd === 'number') {
          return e.portfolio_snapshot.equity_usd;
        }
        if (e && typeof e.equity_usd === 'number') {
          return e.equity_usd;
        }
        return null;
      }

      function findLastVerifiedEquity(entries) {
        for (var i = entries.length - 1; i >= 0; i--) {
          var e = entries[i] || {};
          var snap = String(e.snapshot_status || '').toUpperCase();
          var src = String(e.balance_source || '');
          var eq = pickNumericEquity(e);
          if (snap === 'SYNCED' && src === 'BITGET_READONLY' && typeof eq === 'number') {
            return { equity: eq, date: e.date || null };
          }
        }
        return null;
      }

      function setProof(latest) {
        els.proof.textContent = [
          'date: ' + (latest.date || 'N/A'),
          'allocation: ' + (latest.allocation != null ? latest.allocation + '%' : 'N/A'),
          'btc_price: ' + (latest.btc_price != null ? latest.btc_price : 'null'),
          'price_source: ' + (latest.price_source || 'N/A'),
          'prev_hash: ' + (latest.prev_hash || 'null'),
          'hash: ' + (latest.hash || 'null')
        ].join('\n');
      }

      if (els.copyProof) {
        els.copyProof.addEventListener('click', function () {
          navigator.clipboard.writeText(els.proof.textContent || '').then(function () {
            els.copyProof.textContent = 'Copied';
            setTimeout(function () { els.copyProof.textContent = 'Copy Latest Proof'; }, 1200);
          });
        });
      }

      function applyAction(position) {
        els.action.classList.remove('long', 'cash', 'no-trade');
        var pos = String(position || 'NO_TRADE').toUpperCase();
        if (pos === 'LONG') els.action.classList.add('long');
        else if (pos === 'CASH') els.action.classList.add('cash');
        else els.action.classList.add('no-trade');
        els.action.textContent = actionLabel(pos);
      }

      var url = new URL('log.json', window.location.href);
      url.searchParams.set('ts', String(Date.now()));
      fetch(url.toString(), { cache: 'no-store' })
        .then(function (r) { return r.json(); })
        .then(function (log) {
          var entries = Array.isArray(log.entries) ? log.entries.slice() : [];
          entries.sort(function (a, b) { return String(a.date || '').localeCompare(String(b.date || '')); });
          var latest = log.latest || entries[entries.length - 1] || {};

          var trust = trustState(latest);
          var stalePrice = (latest.price_source === 'cache_stale' || latest.status === 'DATA_STALE');
          var snapEq = pickNumericEquity(latest);
          var fallbackEq = findLastVerifiedEquity(entries);
          var eqTrusted = trust.trusted && typeof snapEq === 'number';
          var action = normalizePosition(latest);
          var targetRatio = (typeof latest.target_btc_ratio === 'number') ? latest.target_btc_ratio : null;
          var actualRatio = (typeof latest.actual_btc_ratio === 'number') ? latest.actual_btc_ratio : null;
          var pnlUsd = (typeof latest.pnl_usd === 'number') ? latest.pnl_usd : null;
          var pnlPct = (eqTrusted && pnlUsd !== null && (snapEq - pnlUsd) > 0)
            ? (pnlUsd / (snapEq - pnlUsd) * 100)
            : null;

          if (typeof snapEq === 'number') {
            els.equity.textContent = fmtUsd(snapEq);
          } else if (fallbackEq && typeof fallbackEq.equity === 'number') {
            els.equity.textContent = fmtUsd(fallbackEq.equity);
          } else {
            els.equity.textContent = '$ ---.--';
          }
          els.pnl.textContent = (pnlUsd !== null)
            ? ((pnlUsd >= 0 ? '+' : '') + fmtUsd(pnlUsd).replace('$', '$') + (pnlPct !== null ? (' / ' + (pnlPct >= 0 ? '+' : '') + pnlPct.toFixed(2) + '%') : ''))
            : ('Status: ' + (latest.status || 'N/A'));
          if (!eqTrusted) {
            if (fallbackEq && fallbackEq.date) {
              els.phaseNote.textContent = 'Latest verified equity shown from ' + fallbackEq.date + ' UTC';
            } else {
              els.phaseNote.textContent = 'Updating latest balance snapshot';
            }
          } else if (typeof snapEq === 'number' && snapEq <= 300) {
            els.phaseNote.textContent = 'Phase 1: $100 Live Testing';
          } else {
            els.phaseNote.textContent = 'Live tracking active';
          }
          applyAction(action);

          if (els.portfolio) {
            if (actualRatio != null) {
              var btcPct = Math.max(0, Math.min(100, actualRatio * 100));
              var cashPct = Math.max(0, 100 - btcPct);
              els.portfolio.textContent = 'Current allocation: BTC ' + btcPct.toFixed(1) + '% / Cash ' + cashPct.toFixed(1) + '%';
            } else {
              els.portfolio.textContent = 'Current allocation: BTC --% / Cash --%';
            }
          }
          if (els.guidance) {
            els.guidance.textContent = 'Guidance: ' + guidanceLabel(action);
          }

          var detail = [];
          detail.push('Target: ' + (targetRatio != null ? Math.round(targetRatio * 100) + '%' : 'N/A'));
          detail.push('Actual: ' + (actualRatio != null ? (actualRatio * 100).toFixed(1) + '%' : 'N/A'));
          detail.push('Trust: ' + trust.label);
          els.trustText.textContent = detail.join(' | ');

          els.date.textContent = 'DATE: ' + (latest.date || 'N/A');
          els.price.textContent = 'PRICE: ' + fmtUsd(latest.btc_price);
          els.updated.textContent = 'UPDATED: ' + (latest.updated_at_utc || 'N/A');
          els.allocation.textContent = (latest.allocation != null ? latest.allocation + '%' : 'N/A');
          els.status.textContent = (latest.status || 'N/A') + (stalePrice ? ' / PRICE_STALE' : '');

          var ci = String(latest.chain_integrity || 'UNKNOWN').toUpperCase();
          els.chain.textContent = ci;
          els.chain.classList.remove('ok', 'warn', 'err');
          if (ci === 'VALID') els.chain.classList.add('ok');
          else if (ci === 'BROKEN') els.chain.classList.add('err');
          else els.chain.classList.add('warn');
          els.chainNote.textContent = String(latest.chain_reason || 'Chain status provided by run_daily.py.');

          renderRows(entries);
          renderChart(entries);
          setProof(latest);
        })
        .catch(function () {
          els.equity.textContent = 'SYSTEM HALTED (API Error)';
          els.action.textContent = 'NO_TRADE';
          els.action.classList.add('no-trade');
          if (els.trustText) {
            els.trustText.textContent = 'Trust: SYSTEM HALTED (API Error)';
          }
          els.proof.textContent = 'Unable to load proof block.';
        });
    })();
  </script>
</body>
</html>
